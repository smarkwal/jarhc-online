AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: API gateway
Parameters:
  ApiDomain:
    Description: Domain name for API gateway
    Type: String
    Default: api.jarhc.org
  CognitoUserPoolARN:
    Description: Cognito User Pool ARN
    Type: String
    Default: arn:aws:cognito-idp:eu-central-1:837783538267:userpool/eu-central-1_duUV8DgO7
  WebsiteURL:
    Description: URL for public website (CloudFront distribution)
    Type: String
    Default: https://online.jarhc.org
  WebsiteBucketName:
    Description: Name of S3 bucket hosting public website
    Type: String
    Default: online.jarhc.org
  WebsiteBucketURL:
    Description: URL of S3 bucket hosting JARHC reports
    Type: String
    Default: https://online.jarhc.org
  DnsZoneID:
    Description: ID of hosted DNS zone
    Type: String
    Default: Z39VOOPW73P7H0
Globals:
  Function:
    Timeout: 5
Resources:
  RestApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Auth:
        ApiKeyRequired: false
        DefaultAuthorizer: CognitoAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn:
              Ref: CognitoUserPoolARN
            Identity:
              Header: Authorization
              ReauthorizeEvery: 300
      Cors:
        AllowOrigin:
          Fn::Sub: '''${WebsiteURL}'''
        AllowMethods: '''GET,POST,OPTIONS'''
        AllowHeaders: '''Content-Type,Authorization'''
        AllowCredentials: true
        MaxAge: '''600'''
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin:
                Fn::Sub: '''${WebsiteURL}'''
              Access-Control-Allow-Credentials: '''true'''
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin:
                Fn::Sub: '''${WebsiteURL}'''
              Access-Control-Allow-Credentials: '''true'''
      EndpointConfiguration:
        Type: REGIONAL
      Domain:
        DomainName:
          Ref: ApiDomain
        CertificateArn:
          Ref: ApiCertificate
        EndpointConfiguration: REGIONAL
        Route53:
          HostedZoneId:
            Ref: DnsZoneID
          EvaluateTargetHealth: false
          IpV6: false
      MethodSettings:
        - HttpMethod: '*'
          ResourcePath: /*
          ThrottlingRateLimit: 10
          ThrottlingBurstLimit: 20
      Models:
        JapiccSubmitModel:
          type: object
          required:
            - oldVersion
            - newVersion
          properties:
            oldVersion:
              type: string
            newVersion:
              type: string
          additionalProperties: false
        JarhcSubmitModel:
          type: object
          required:
            - classpath
          properties:
            classpath:
              type: array
              items:
                type: string
            provided:
              type: array
              items:
                type: string
          additionalProperties: false
        MavenSearchModel:
          type: object
          required:
            - coordinates
          properties:
            coordinates:
              type: string
          additionalProperties: false
    Metadata:
      SamResourceId: RestApi
  ErrorQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: jarhc-online-error-queue
      MessageRetentionPeriod: 1209600
    Metadata:
      SamResourceId: ErrorQueue
  RestApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: rest-api
      AutoPublishAlias: Live
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-lcbyi0cw90q3/jarhc-online-api/2d1a8b550a8d0086639fe92705c1363d
      Handler: org.jarhc.online.rest.Handler
      Runtime: java11
      Architectures:
        - x86_64
      Tracing: Active
      Role:
        Fn::GetAtt:
          - RestApiFunctionRole
          - Arn
      MemorySize: 512
      Timeout: 10
      Events:
        AuthValidate:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /auth/validate
            Method: GET
        JapiccSubmit:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /japicc/submit
            Method: POST
            RequestModel:
              Model: JapiccSubmitModel
              Required: true
              ValidateBody: true
              ValidateParameters: false
        JarhcSubmit:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /jarhc/submit
            Method: POST
            RequestModel:
              Model: JarhcSubmitModel
              Required: true
              ValidateBody: true
              ValidateParameters: false
        MavenSearch:
          Type: Api
          Properties:
            RestApiId:
              Ref: RestApi
            Path: /maven/search
            Method: POST
            Auth:
              Authorizer: NONE
            RequestModel:
              Model: MavenSearchModel
              Required: true
              ValidateBody: true
              ValidateParameters: false
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: WebsiteBucketName
          BUCKET_URL:
            Ref: WebsiteBucketURL
          JAVA_TOOL_OPTIONS: -XX:+TieredCompilation -XX:TieredStopAtLevel=1
    Metadata:
      SamResourceId: RestApiFunction
  RestApiFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: rest-api-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaRole
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
    Metadata:
      SamResourceId: RestApiFunctionRole
  JapiccCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: japicc-check
      AutoPublishAlias: Live
      PackageType: Image
      Architectures:
        - x86_64
      Tracing: Active
      Role:
        Fn::GetAtt:
          - AsyncFunctionRole
          - Arn
      MemorySize: 1024
      Timeout: 60
      EventInvokeConfig:
        MaximumEventAgeInSeconds: 120
        MaximumRetryAttempts: 0
      DeadLetterQueue:
        Type: SQS
        TargetArn:
          Fn::GetAtt:
            - ErrorQueue
            - Arn
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: WebsiteBucketName
          BUCKET_URL:
            Ref: WebsiteBucketURL
      ImageUri: 837783538267.dkr.ecr.eu-central-1.amazonaws.com/jarhc-online-api:japicccheckfunction-adb1ce521f2b-v1
    Metadata:
      DockerContext: /Users/markwalder/Documents/Private/IntelliJ/jarhc-online/sam-api/japicc-check
      DockerTag: v1
      Dockerfile: Dockerfile
      SamResourceId: JapiccCheckFunction
  JarhcCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: jarhc-check
      AutoPublishAlias: Live
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-lcbyi0cw90q3/jarhc-online-api/0e7882a16924b5dce32769213f64627d
      Handler: org.jarhc.online.jarhc.Handler
      Runtime: java11
      Architectures:
        - x86_64
      Tracing: Active
      Role:
        Fn::GetAtt:
          - AsyncFunctionRole
          - Arn
      MemorySize: 1024
      Timeout: 60
      EventInvokeConfig:
        MaximumEventAgeInSeconds: 120
        MaximumRetryAttempts: 0
      DeadLetterQueue:
        Type: SQS
        TargetArn:
          Fn::GetAtt:
            - ErrorQueue
            - Arn
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: WebsiteBucketName
          BUCKET_URL:
            Ref: WebsiteBucketURL
    Metadata:
      SamResourceId: JarhcCheckFunction
  AsyncFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: async-function-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonSQSFullAccess
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
    Metadata:
      SamResourceId: AsyncFunctionRole
  ApiCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName:
        Ref: ApiDomain
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName:
            Ref: ApiDomain
          HostedZoneId:
            Ref: DnsZoneID
    Metadata:
      SamResourceId: ApiCertificate
Outputs:
  ApiGatewayUrl:
    Description: Base URL of API Gateway.
    Value:
      Fn::Sub: https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
